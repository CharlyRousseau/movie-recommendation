name: Deploy to SFTP and Restart Services

on:
  push:
    branches:
      - main

jobs:
  deploy-api:
    runs-on: ubuntu-latest  
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Deploy API to SFTP
        run: |
          lftp -e "set sftp:auto-confirm yes; open -u ${{ secrets.SFTP1_USERNAME }},${{ secrets.SFTP_PASSWORD }} sftp://${{ secrets.SFTP1_HOST }}; mirror -R ./movie-recommendation-api /remote/path/api; bye"

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Deploy Frontend to SFTP
        run: |
          lftp -e "set sftp:auto-confirm yes; open -u ${{ secrets.SFTP2_USERNAME }},${{ secrets.SFTP_PASSWORD }} sftp://${{ secrets.SFTP2_HOST }}; mirror -R ./movie-recommendation-frontend /remote/path/frontend; bye"

  restart-api:
    needs: [deploy-api]
    runs-on: ubuntu-latest
    steps:
      - name: Restart API Server
        run: |
          curl "https://panel.cursehosting.com/api/client/service/39cfea52/power" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -X POST \
            -d '{"signal": "restart"}'

  restart-frontend:
    needs: [deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Restart Frontend Server
        run: |
          curl "https://panel.cursehosting.com/api/client/service/6b74f8f4/power" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -X POST \
            -d '{"signal": "restart"}'
